<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSHP èª²ç¨‹æŸ¥è©¢çµæœ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-open { background-color: #d1e7dd; color: #0f5132; font-weight: bold; padding: 4px 8px; border-radius: 4px; }
        .status-full { background-color: #f8d7da; color: #842029; padding: 4px 8px; border-radius: 4px; }
        .table-hover tbody tr:hover { background-color: #f2f2f2; }
        a { text-decoration: none; color: #0d6efd; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body class="bg-light p-4">
    <div class="container bg-white p-4 rounded shadow">
        <h2 class="mb-4 border-bottom pb-2">ğŸ¥ èª²ç¨‹è‡ªå‹•æŸ¥è©¢ç³»çµ±</h2>
        
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">æŸ¥è©¢è¨­å®š</div>
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-5">
                        <label class="form-label">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">çµæŸæ—¥æœŸ</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <button onclick="saveAndFilter()" class="btn btn-dark w-100">ä¿å­˜ä¸¦æŸ¥è©¢</button>
                    </div>
                </div>
                <div class="form-text mt-2 text-muted">
                    * è¨­å®šæœƒè‡ªå‹•å„²å­˜åœ¨æ­¤ç€è¦½å™¨ä¸­ã€‚ç³»çµ±æ¯æ—¥æ—©ä¸Š 09:00 æ›´æ–°è³‡æ–™åº«ã€‚
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th width="20%">èª²ç¨‹æœŸé–“</th>
                        <th width="50%">èª²ç¨‹ä¸»é¡Œ</th>
                        <th width="10%">ç©åˆ†</th>
                        <th width="20%">å ±åè³‡è¨Š</th>
                    </tr>
                </thead>
                <tbody id="courseTable">
                    <tr><td colspan="4" class="text-center py-4">è³‡æ–™è®€å–ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="text-end text-muted mt-3 small">
            è³‡æ–™æœ€å¾Œæ›´æ–°ï¼š<span id="lastUpdate">--</span>
        </div>
    </div>

    <script>
        let allData = [];

        window.onload = async function() {
            // è®€å–ä¿å­˜çš„è¨­å®š
            const savedStart = localStorage.getItem('startDate');
            const savedEnd = localStorage.getItem('endDate');
            
            if(savedStart) document.getElementById('startDate').value = savedStart;
            if(savedEnd) document.getElementById('endDate').value = savedEnd;

            await loadData();
        };

        function saveAndFilter() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            // ä¿å­˜è¨­å®š
            localStorage.setItem('startDate', start);
            localStorage.setItem('endDate', end);
            
            renderTable();
            alert("è¨­å®šå·²ä¿å­˜ï¼");
        }

        async function loadData() {
            try {
                // è®€å– JSON æª”æ¡ˆ (åŠ ä¸Š timestamp é˜²æ­¢å¿«å–)
                const response = await fetch('data.json?t=' + new Date().getTime());
                const json = await response.json();
                
                document.getElementById('lastUpdate').innerText = json.last_updated;
                allData = json.data;
                renderTable();
            } catch (error) {
                console.error(error);
                document.getElementById('courseTable').innerHTML = '<tr><td colspan="4" class="text-center text-danger">ç„¡æ³•è®€å–è³‡æ–™ (data.json å°šæœªç”Ÿæˆ)</td></tr>';
            }
        }

        function renderTable() {
            const tbody = document.getElementById('courseTable');
            const userStart = document.getElementById('startDate').value;
            const userEnd = document.getElementById('endDate').value;
            
            tbody.innerHTML = '';

            const filtered = allData.filter(item => {
                if (!userStart || !userEnd) return true;
                
                // è™•ç†æ—¥æœŸæ ¼å¼ (ç¶²é å¯èƒ½æ˜¯æ°‘åœ‹å¹´ 113/01/01 æˆ–è¥¿å…ƒ 2024/01/01)
                // æˆ‘å€‘åªå– "é–‹å§‹æ—¥æœŸ" ä¾†æ¯”è¼ƒ
                let dateStr = item.period.split('~')[0].trim();
                let parts = dateStr.match(/(\d+)\/(\d+)\/(\d+)/);
                
                if (parts) {
                    let year = parseInt(parts[1]);
                    // å¦‚æœæ˜¯æ°‘åœ‹å¹´ï¼Œè½‰è¥¿å…ƒ
                    if (year < 1911) year += 1911;
                    
                    let fmtDate = `${year}-${parts[2]}-${parts[3]}`;
                    return fmtDate >= userStart && fmtDate <= userEnd;
                }
                return true; // è‹¥ç„¡æ³•è§£ææ—¥æœŸï¼Œé è¨­é¡¯ç¤º
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">æ­¤æ—¥æœŸå€é–“ç„¡ç¬¦åˆèª²ç¨‹ã€‚</td></tr>';
                return;
            }

            filtered.forEach(item => {
                let statusClass = 'text-secondary';
                if (item.reg_status.includes("é–‹æ”¾")) statusClass = 'status-open';
                if (item.reg_status.includes("é¡æ»¿") || item.reg_status.includes("æˆªæ­¢")) statusClass = 'status-full';

                const row = `
                    <tr>
                        <td>${item.period}</td>
                        <td><a href="${item.link}" target="_blank" class="fw-bold">${item.topic}</a></td>
                        <td><span class="badge bg-secondary">${item.points}</span></td>
                        <td><span class="${statusClass}">${item.reg_status}</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
    </script>
</body>
</html>